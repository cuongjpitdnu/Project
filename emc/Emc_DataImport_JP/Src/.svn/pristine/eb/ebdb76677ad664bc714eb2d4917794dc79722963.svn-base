<?php
    /*
     * @link_edit.php
     *
     * @create 2020/03/13 AKB Thang
     */


    require_once('common/common.php');
    require_once('common/session_check.php');
    header('Content-type: text/html; charset=utf-8');
    header('X-FRAME-OPTIONS: DENY');
    //DB接続
    if(fncConnectDB() == false){
        $_SESSION['LOGIN_ERROR'] = 'DB接続に失敗しました。';
        header('Location: login.php');
        exit;
    }
    //user not login, redirect to login.php
    if(!isset($_SESSION['LOGINUSER_INFO'])){
        echo "
        <script>
            alert('".PUBLIC_MSG_008_JPN . "/" . PUBLIC_MSG_008_ENG."');
            window.location.href = 'login.php';
        </script>
        ";
        exit();
    }

    //sesstion check
    fncSessionTimeOutCheck();

    //if request is not ajax, exit
    if(
        !(!empty($_SERVER['HTTP_X_REQUESTED_WITH'])
        && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest')
    )
    {    
        exit;    
    }
    $_SESSION['LINK_EDIT_MSG_ERROR_INPUT'] = '';
    define('SCREEN_NAME', 'リンク情報登録編集画面');
    define('SCREEN_NAME_VIEW', 'リンク情報登録編集画面 表示');
    $arrUserInfo = unserialize($_SESSION['LOGINUSER_INFO']);
    //log view
    fncWriteLog(
        LogLevel['Info'],
        LogPattern['View'],
        SCREEN_NAME_VIEW . ' (ユーザID = '.$arrUserInfo->strUserID.')'
    );

    // get list text translate
    $arrTitle =  array(
        'LINK_EDIT_TEXT_001',
        'LINK_EDIT_TEXT_002',
        'LINK_EDIT_TEXT_003',
        'LINK_EDIT_TEXT_004',
        'LINK_EDIT_TEXT_005',
        'LINK_EDIT_TEXT_006',
        'LINK_EDIT_MSG_001',
        'PUBLIC_TEXT_009',
        'PUBLIC_BUTTON_003',
        'PUBLIC_BUTTON_013',
        'PUBLIC_MSG_009',
        'LINK_EDIT_MSG_013',
        'LINK_EDIT_MSG_011'
    );
    $arrTextTranslate = getListTextTranslate($arrTitle, $arrUserInfo->intLanguageType);
    

    //redirect if dont have permission
    if($arrUserInfo->intMenuPerm == 0){
        echo "
        <script>
            alert('".$arrTextTranslate['PUBLIC_MSG_009']."');
            window.location.href = 'login.php';
        </script>
        ";
    }


    if(isset($_POST['id'])){
        //$_POST['id'] == 0, add new link
        if($_POST['id'] != 0){
            //process edit link
            $arrOneLink = fncSelectOne(
                "SELECT * FROM t_link WHERE LINK_NO=?",
                [$_POST['id']],
                SCREEN_NAME
            );
            if(!$arrOneLink){
                //link not exist, return error msg
                $errMsg = $arrTextTranslate['LINK_EDIT_MSG_013'];

?>
<script>
    $('.error').html('<?php echo $errMsg; ?>');
    $('#myModal').modal('hide');

</script>
<?php
            exit();
        }
    }
    //continue to edit link
            
    //get link cats 
    $strSQL = "SELECT LINK_CATEGORY_NO,";
    $strSQL .= iff(
        $arrUserInfo->intLanguageType,
        " LINK_CATEGORY_NAME_ENG as LINK_CATEGORY_NAME,",
        " LINK_CATEGORY_NAME_JPN as LINK_CATEGORY_NAME,"
    );
    $strSQL .= " SORT_NO";
    $strSQL .= " FROM m_link_category ORDER BY SORT_NO ASC";

    $arrLinkCategoryList= fncSelectData($strSQL, [], 1, false, SCREEN_NAME);
?>
<div class="main-content">
    <div class="main-form">
    <form class="formEdit" action="link_edit_proc.php" enctype="multipart/form-data">
        <input type="hidden" name="mode" class="t-input t-input-250" value="1">
        <input type="hidden" name="LINK_NO" class="t-input t-input-250" value="<?php
            if(isset($arrOneLink['LINK_NO'])) echo $arrOneLink['LINK_NO']; 
        ?>">
        <input type="hidden" name="X-CSRF-TOKEN" value="<?php
            if(isset($_SESSION['csrf'])) echo $_SESSION['csrf'];
        ?>">
        <div class="form-title">
            <?php echo $arrTextTranslate['LINK_EDIT_TEXT_001']; ?>
        </div>
        <div class="edit-error" style="color:red;"></div>
        <div class="form-body-90 top-20">
            <div class="lb-left-long">
                <?php echo $arrTextTranslate['LINK_EDIT_TEXT_002']; ?>
            </div>
            <div class="select-container" style="margin-left: 15px">
                <select name="LINK_CATEGORY_NO">
                    <?php echo !isset($arrOneLink['LINK_CATEGORY_NO']) ? '<option value="">' : '' ?>
                    <?php foreach($arrLinkCategoryList as $arrLinkCategory){
                        echo '<option value="'.$arrLinkCategory['LINK_CATEGORY_NO'].'" '
                        .(isset($arrOneLink['LINK_CATEGORY_NO']) 
                        && $arrOneLink['LINK_CATEGORY_NO']==$arrLinkCategory['LINK_CATEGORY_NO'] 
                        ? 'selected': '').'>'
                        .fncHtmlSpecialChars($arrLinkCategory['LINK_CATEGORY_NAME'])
                        .'</option>';
                    } ?>
                </select>
            </div><br/>

            <div class="lb-left-long"><?php echo $arrTextTranslate['LINK_EDIT_TEXT_003']; ?></div>
            <span class="ip-span">
                <input type="text" name="LINK_NAME_JPN" class="t-input" value="<?php
                    echo isset($arrOneLink['LINK_NAME_JPN']) ? $arrOneLink['LINK_NAME_JPN'] : '';
                ?>">
            </span>

            <div class="lb-left-long">
                <?php echo $arrTextTranslate['LINK_EDIT_TEXT_004']; ?>
            </div>
            <span class="ip-span">
                <input type="text" name="LINK_NAME_ENG" class="t-input" value="<?php
                echo isset($arrOneLink['LINK_NAME_ENG']) ? $arrOneLink['LINK_NAME_ENG'] : '';
                ?>">
            </span>

            <div class="lb-left-long">
                <?php echo $arrTextTranslate['LINK_EDIT_TEXT_005']; ?>
            </div>
            <span class="ip-span">
                <input type="text" name="URL" class="t-input" value="<?php
                    echo isset($arrOneLink['URL']) ? $arrOneLink['URL'] : ''; 
                ?>">
            </span>

            <div class="lb-left-long">
                <?php echo $arrTextTranslate['LINK_EDIT_TEXT_006']; ?>
            </div>
            <div class="upload-file ip-span">
                <?php if(isset($arrOneLink)){
                    $strPathTmp = SHARE_FOLDER . '/' . LINK_EDIT_FOLDER . '/' 
                    . $arrOneLink['LINK_NO'] . '/1/' . $arrOneLink['BURNER_FILE_NAME1'];
                ?>

                <div class="singe-line">
                    <div class="in-line">
                        <a <?php echo isset($arrOneLink['BURNER_FILE_NAME1'])
                        && $arrOneLink['BURNER_FILE_NAME1'] != '' 
                        ? 'href="#"'.(!file_exists(
                                SHARE_FOLDER.'/'.LINK_EDIT_FOLDER.'/' 
                                .$arrOneLink['LINK_NO'] . '/1/' . $arrOneLink['BURNER_FILE_NAME1']
                            ) ? ' class="no-file"' 
                            : ' onclick="downloadURI(\''.base64_encode($strPathTmp)
                            .'\', \'request_edit_proc.php\', \''
                            .$arrTextTranslate['LINK_EDIT_MSG_011'].'\')"')
                        : '' ?> class="link" 
                        ><?php echo isset($arrOneLink['BURNER_FILE_NAME1']) 
                        ? $arrOneLink['BURNER_FILE_NAME1'] : ''; ?></a>
                    </div>
                    
                    <?php if(
                        isset($arrOneLink['BURNER_FILE_NAME1'])
                        && $arrOneLink['BURNER_FILE_NAME1'] != ''
                    ){ ?>
                    <div class="in-line col-right right-20">
                        <input type="checkbox" name="chkDelete">
                        <?php echo $arrTextTranslate['PUBLIC_TEXT_009']; ?>
                    </div>
                    <div style="clear:both;"></div>
                    <?php } ?>
                </div>
                    <?php } ?>
                <div class="singe-line">
                    <input type="file" accept="image/*" name="file" id="file-upload" 
                    class="t-input" <?php 
                        echo isset($arrOneLink['BURNER_FILE_NAME1']) 
                        && $arrOneLink['BURNER_FILE_NAME1']!='' ? 'disabled' : '';
                        ?>>
                </div>
            </div>

            <div class="form-footer top-20 text-right">
            <button type="submit" class="tbtn-cancel tbtn-defaut btn-save-edit-file">
                <?php echo $arrTextTranslate['PUBLIC_BUTTON_013']; ?>
            </button>
            <button type="submit" class="tbtn-cancel tbtn-defaut" 
            id="close-setting" data-dismiss="modal">
                <?php echo $arrTextTranslate['PUBLIC_BUTTON_003']; ?>
            </button>
            </div>

        </div>
    </form>
    </div>
</div>
<canvas id="canvas1" style="display: none;"></canvas>
<script>
    $('[name="chkDelete"]').click(function(){
        var t = $(this).prop('checked');
        if(t){
            $('[name="file"]').attr('disabled', false);
        }else{
            $('[name="file"]').attr('disabled', true);
        }
    });
    var confirmMsg = '<?php echo $arrTextTranslate['LINK_EDIT_MSG_001']; ?>';
    var fileNotExistMessage = '<?php echo $arrTextTranslate['LINK_EDIT_MSG_011']; ?>';
    $('.no-file').click(function(e){
        e.preventDefault();
        $('.edit-error').html(fileNotExistMessage);
        
    });
</script>
<?php
    }else{
        echo "
        <script>
            alert('".PUBLIC_MSG_008_JPN."/".PUBLIC_MSG_008_ENG."');
            window.location.href = 'login.php';
        </script>
        ";
        exit();
    }
?>