<?php 

require_once('common/common.php');
header('Content-type: text/html; charset=utf-8');
header('X-FRAME-OPTIONS: DENY');
//DB接続
if(fncConnectDB() == false){
	echo "
    <script>
        alert('".PUBLIC_MSG_008_JPN . "/" . PUBLIC_MSG_008_ENG."');
        window.location.href = 'login.php';
    </script>
    ";
	exit();
}
if(!isset($_SESSION['LOGINUSER_INFO'])){
    echo "
    <script>
        alert('".PUBLIC_MSG_008_JPN . "/" . PUBLIC_MSG_008_ENG."');
        window.location.href = 'login.php';
    </script>
    ";

	exit();
}
$_SESSION['errStr'] = '';

$userInfo = unserialize($_SESSION['LOGINUSER_INFO']);

fncWriteLog(LogLevel['Info'] , LogPattern['View'] , 'リンク情報登録編集画面 表示 (ユーザID = '.$userInfo->strUserID.')');

// get list text translate
$arrTitle =  array(
    'LINK_EDIT_TEXT_001',
    'LINK_EDIT_TEXT_002',
    'LINK_EDIT_TEXT_003',
    'LINK_EDIT_TEXT_004',
    'LINK_EDIT_TEXT_005',
    'LINK_EDIT_TEXT_006',
    'LINK_EDIT_MSG_001',


    'PUBLIC_TEXT_006',
    'PUBLIC_TEXT_007',
    'PUBLIC_TEXT_009',


    'PUBLIC_BUTTON_003',
    'PUBLIC_BUTTON_013',
    'PUBLIC_MSG_009',
    'LINK_EDIT_MSG_013'


    
);

$arrTextTranslate = getListTextTranslate($arrTitle, $userInfo->intLanguageType);




$user = fncSelectOne("SELECT USER_NO FROM m_user WHERE USER_NO=?",
    [$userInfo->intUserNo], 'リンク情報登録編集画面');
if(!$user){
    echo "
    <script>
        alert('".$arrTextTranslate['PUBLIC_MSG_008']."');
        window.location.href = 'login.php';
    </script>
    ";

	exit();
}

//redirect if dont have permission
if($userInfo->intMenuPerm == 0){
    echo "
    <script>
        alert('".$arrTextTranslate['PUBLIC_MSG_009']."');
        window.location.href = 'login.php';
    </script>
    ";
}


if(isset($_POST['id'])){
    if($_POST['id'] != 0){
        //process edit company
        $row = fncSelectOne("SELECT * FROM t_link WHERE LINK_NO=?", [$_POST['id']], 'リンク情報登録編集画面');
        if(!$row){
            // print_r($row);
            //user not exist, return error msg
            $errMsg = $arrTextTranslate['LINK_EDIT_MSG_013'];

?>
    <script>
        alert('<?php echo $errMsg; ?>');

        $('#myModal').modal('hide');

    </script>


<?php
            exit();
        }
    }
    // print_r($row);
    //continue to edit link
            
    //get link cats 
    $strSQL = "SELECT LINK_CATEGORY_NO,";
    $strSQL .= iff($userInfo->intLanguageType, " LINK_CATEGORY_NAME_ENG as LINK_CATEGORY_NAME,", " LINK_CATEGORY_NAME_JPN as LINK_CATEGORY_NAME,");
    $strSQL .= " SORT_NO";
    $strSQL .= " FROM m_link_category ORDER BY SORT_NO ASC";

    $cats= fncSelectData($strSQL, [], 1, false, 'リンク情報登録編集画面');
?>
<div class="main-content">
    <div class="main-form">
    <form class="formEdit" action="link_edit_proc.php">
        <input type="hidden" name="mode" class="t-input t-input-250" value="1">
        <input type="hidden" name="LINK_NO" class="t-input t-input-250" value="<?php if(isset($row['LINK_NO'])) echo $row['LINK_NO']; ?>">
        <input type="hidden" name="X-CSRF-TOKEN" value="<?php if(isset($_SESSION['csrf'])) echo $_SESSION['csrf']; ?>">
        <div class="form-title"><?php echo $arrTextTranslate['LINK_EDIT_TEXT_001']; ?></div>
        <div class="edit-error" style="color:red;"></div>
        <div class="form-body-90 top-20">
            <div class="lb-left-long"><?php echo $arrTextTranslate['LINK_EDIT_TEXT_002']; ?></div>
            <div class="select-container" style="margin-left: 15px">
                <select name="LINK_CATEGORY_NO">
                    <?php echo !isset($row['LINK_CATEGORY_NO']) ? '<option value="">' : '' ?>
                    <?php foreach($cats as $cat){
                        echo '<option value="'.$cat['LINK_CATEGORY_NO'].'" '.(isset($row['LINK_CATEGORY_NO']) && $row['LINK_CATEGORY_NO']==$cat['LINK_CATEGORY_NO'] ? 'selected': '').'>'.$cat['LINK_CATEGORY_NAME'].'</option>';
                    } ?>
                </select>
            </div><br/>

            <div class="lb-left-long"><?php echo $arrTextTranslate['LINK_EDIT_TEXT_003']; ?></div>
            <span class="ip-span"><input type="text" name="LINK_NAME_JPN" class="t-input" value="<?php echo isset($row['LINK_NAME_JPN']) ? $row['LINK_NAME_JPN'] : ''; ?>"></span>

            <div class="lb-left-long"><?php echo $arrTextTranslate['LINK_EDIT_TEXT_004']; ?></div>
            <span class="ip-span"><input type="text" name="LINK_NAME_ENG" class="t-input" value="<?php echo isset($row['LINK_NAME_ENG']) ? $row['LINK_NAME_ENG'] : ''; ?>"></span>

            <div class="lb-left-long"><?php echo $arrTextTranslate['LINK_EDIT_TEXT_005']; ?></div>
            <span class="ip-span"><input type="text" name="URL" class="t-input" value="<?php echo isset($row['URL']) ? $row['URL'] : ''; ?>"></span>

            <div class="lb-left-long"><?php echo $arrTextTranslate['LINK_EDIT_TEXT_006']; ?></div>
            <div class="upload-file ip-span">
                <div class="singe-line">
                    <div class="in-line"><a href="#" class="link"><?php echo isset($row['BURNER_FILE_NAME1']) ? $row['BURNER_FILE_NAME1'] : ''; ?></a></div>
                    <div class="in-line col-right right-20">
                        <input type="checkbox" name="chkDelete"><?php echo $arrTextTranslate['PUBLIC_TEXT_009']; ?>
                    </div>
                    <div style="clear:both;"></div>
                </div>
                <div class="singe-line" style="border-top: none;">
                    <input type="file" name="file" class="t-input" disabled>
                </div>
            </div>

            <div class="form-footer top-20 text-right">
            <button type="submit" class="tbtn-cancel tbtn-defaut btn-save-edit"><?php echo $arrTextTranslate['PUBLIC_BUTTON_013']; ?></button>
            <button type="submit" class="tbtn-cancel tbtn-defaut " id="close-setting" data-dismiss="modal"><?php echo $arrTextTranslate['PUBLIC_BUTTON_003']; ?></button>
            </div>

        </div>
    </form>
    </div>
</div>
<script>
    $('[name="chkDelete"]').click(function(){
        var t = $(this).prop('checked');
        if(t){
            $('[name="file"]').attr('disabled', false);
        }else{
            $('[name="file"]').attr('disabled', true);
        }
    });
    var confirmMsg = '<?php echo $arrTextTranslate['LINK_EDIT_MSG_001']; ?>'
</script>
<?php 

}else{
    echo "
    <script>
        alert('".PUBLIC_MSG_008_JPN."/".PUBLIC_MSG_008_ENG."');
        window.location.href = 'login.php';
    </script>
    ";
    exit();
}
?>