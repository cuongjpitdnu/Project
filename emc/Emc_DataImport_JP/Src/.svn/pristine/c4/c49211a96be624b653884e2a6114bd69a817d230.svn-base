<?php
    // -------------------------------------------------------------------------
    //	function	:
    //	create		:
    //	update		:
    // -------------------------------------------------------------------------
    require_once('common/common.php');
    require_once('user_mng_proc.php');

    header('Content-type: text/html; charset=utf-8');
    header('X-FRAME-OPTIONS: DENY');

    //セッションスタート

    if(fncConnectDB() == false){
        $_SESSION['LOGIN_ERROR'] = 'DB接続に失敗しました。';
        header('Location: login.php');
        exit;
    }

    $arrMGroup = fncGetMGroup($intLanguageType);

    $arrLoginError = (isset($_SESSION['USER_MNG_ERROR'])) ? $_SESSION['USER_MNG_ERROR'] : array();

    // check page first time or refresh
    $pageWasRefreshed = isset($_SERVER['HTTP_CACHE_CONTROL']) && ($_SERVER['HTTP_CACHE_CONTROL'] === 'max-age=0' || $_SERVER['HTTP_CACHE_CONTROL'] == 'no-cache');;
    if(!$pageWasRefreshed) {
        $_SESSION['USER_MNG_ERROR'] = array();
        $_SESSION['user_mng'] = array(
            'userIdSearch' => null,
            'companyNameSearch' => null,
            'groupNoSearch' => null,
            'userNameSearch' => null
        );
    }

    if(!isset($_SESSION['LOGINUSER_INFO'])) {
        header('Location: login.php');
        exit;
    }

    // ログインユーザ情報を取得
    $objLoginUserInfo = unserialize($_SESSION['LOGINUSER_INFO']);

    $intLanguageType = $objLoginUserInfo->intLanguageType;

    $arrTitleMsg =  array(
        // msg do not have permission
        'PUBLIC_MSG_009',

        'USER_MNG_TEXT_001',
        'USER_MNG_TEXT_002',
        'USER_MNG_TEXT_003',
        'USER_MNG_TEXT_004',
        'USER_MNG_TEXT_005',
        'USER_MNG_TEXT_006',
        'USER_MNG_TEXT_007',
        'USER_MNG_TEXT_008',
        'USER_MNG_TEXT_009',
        'USER_MNG_TEXT_010',
        'USER_MNG_TEXT_011',
        'PUBLIC_BUTTON_009',
        'PUBLIC_BUTTON_010',
        'USER_MNG_TEXT_012',
        'PUBLIC_BUTTON_006',
        'PUBLIC_BUTTON_001',
        'PUBLIC_BUTTON_011',
        'PUBLIC_BUTTON_015',

        // get data grid = false
        'PUBLIC_MSG_001',

        // delete data = false
        'PUBLIC_MSG_004',

        // csv title
        'USER_MNG_TEXT_013',
        'USER_MNG_TEXT_014',
        'USER_MNG_TEXT_015',
        'USER_MNG_TEXT_016',
        'USER_MNG_TEXT_017',
        'USER_MNG_TEXT_018',
        'USER_MNG_TEXT_019',
        'USER_MNG_TEXT_020',
        'USER_MNG_TEXT_021',
        'USER_MNG_TEXT_022',
        'USER_MNG_TEXT_023',
        'USER_MNG_TEXT_024',
        'USER_MNG_TEXT_025',
        'USER_MNG_TEXT_026',
        'USER_MNG_TEXT_027',
        'USER_MNG_TEXT_028',

        'PUBLIC_TEXT_006',
        'PUBLIC_TEXT_007',

        // msg delete user
        'USER_MNG_MSG_001',

        // export data csv = false
        'PUBLIC_MSG_005',
    );

    $arrTextTranslate = getListTextTranslate($arrTitleMsg, $intLanguageType);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="csrf-token" content="<?php echo (isset($csrf) ? $csrf : ''); ?>">
    <meta charset="UTF-8">
    <title><?php echo $arrTextTranslate['USER_MNG_TEXT_001']; ?></title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="css/table.css">

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link type="text/css" href="css/smoothness/jquery-ui-1.10.4.custom.css" rel="stylesheet" />
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.10.4.custom.js"></script>
    <script type="text/javascript" src="js/jquery.ui.datepicker-ja.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- <script src="js/nextpage.js"></script> -->
    <script src="js/common.js"></script>
    <?php if($objLoginUserInfo->intMenuPerm == 0) {   // permission 各種メニュー権限[intMenuPerm] ?>
        <script type="text/javascript">
            alert('<?php echo $arrTextTranslate['PUBLIC_MSG_009']; ?>');
            window.location.href = 'login.php';
        </script>
    <?php exit; } ?>
</head>
<body>
    <div class="main-content">
        <div class="main-form">
            <div class="form-title"><?php echo $arrTextTranslate['USER_MNG_TEXT_001']; ?></div>
            <font color="red" class="error">
                <?php
                    if(count($arrLoginError) > 0) {
                        $html = '';
                        foreach($arrLoginError as $value) {
                            $html .= '<div>'.$value.'</div>';
                        }
                        echo $html;
                    }
                ?>
            </font>
            <div class="form-body">
                <form class="search-form" name="searchForm" action="" method="post">
                    <input type="hidden" name="loadList" value="1">
                    <input type="hidden" name="currentPage" value="1">
                    <div class="cont-title">
                        <div class=" in-line">
                            <div class="label-80"><?php echo $arrTextTranslate['USER_MNG_TEXT_002']; ?></div>
                            <input type="text" class="t-input t-input-125" name="userId" value="<?php echo (isset($_SESSION['user_mng']['userIdSearch'])) ? $_SESSION['user_mng']['userIdSearch'] : ''; ?>">
                        </div>
                        <div class="in-line">
                            <div class="label-80"><?php echo $arrTextTranslate['USER_MNG_TEXT_003']; ?></div>
                            <input type="text" class="t-input t-input-125" name="companyName" value="<?php echo (isset($_SESSION['user_mng']['companyNameSearch'])) ? $_SESSION['user_mng']['companyNameSearch'] : ''; ?>">
                        </div>
                        <div class="in-line">
                            <div class="label-80"><?php echo $arrTextTranslate['USER_MNG_TEXT_004']; ?></div>
                            <div class="select-container">
                                <select class="select-150" name="groupNo">
                                    <?php
                                        $html = '';
                                        $html .= '<option value="">All</option>';
                                        if($arrMGroup != 0 && count($arrMGroup) > 0) {
                                            foreach ($arrMGroup as $value) {
                                                $checked = (isset($_SESSION['user_mng']['groupNoSearch'])) ? (($_SESSION['user_mng']['groupNoSearch'] == $value['group_no']) ? 'selected' : '') : '';
                                                $html .= '<option value="'.$value['group_no'].'" '.$checked.'>'.$value['group_name'].'</option>';
                                            }
                                        }
                                        echo $html;
                                    ?>
                                </select>
                            </div>
                        </div>
                        <div class="in-line">
                            <div class="label-80"><?php echo $arrTextTranslate['USER_MNG_TEXT_005']; ?></div>
                            <input type="text" class="t-input t-input-125" name="userName" value="<?php echo (isset($_SESSION['user_mng']['userNameSearch'])) ? $_SESSION['user_mng']['userNameSearch'] : ''; ?>">
                        </div>
                        <div class="in-line">
                            <input type="button" class="tbl-btn tbl-btn-action btn-search-user" value="<?php echo $arrTextTranslate['PUBLIC_BUTTON_006']; ?>">
                        </div>
                    </div>
                </form>

                <div class="ajax-content"></div>
            </div>
        </div>
    </div>

    <!-- Modal HTML -->
    <div id="myModal" class="modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div id="modal-body">

                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var ajaxUrl = '';
        var pageWasRefreshed = '<?php echo $pageWasRefreshed; ?>';
        $(document).ready(function() {
            if(pageWasRefreshed == 1) {
                loadData(1);
            } else {
                loadData(0);
            }

            $('.btn-search-user').on('click', function(e) {
                $('.error').html('');
                e.preventDefault();
	        	loadData(1);
            });

            $(document).on('click', '.btnOutput', function(e) {
                e.preventDefault();
                $('.error').html('');
                // $('[name=mode]').val(2);
                $('[name=mode]').val(1);
                var data = $('.search-form').serialize();
                $('[name=searchData]').val(data);
                $("#formCSV").submit();
            });

            // $(document).on('click', '.btn-del-user', function(e) {
            //     e.preventDefault();
            //     $('.error').html('');
            //     if(confirm('<?php //echo $arrTextTranslate['USER_MNG_MSG_001']; ?>')) {
            //         var arr = [
            //             { name: 'X-CSRF-TOKEN', value: '<?php //echo (isset($csrf) ? $csrf : ''); ?>'},
            //             { name: 'user_no', value: $(this).attr('data-id') },
            //             { name: 'mode', value: 1 }
            //         ];
            //         $.ajax({
            //             url: 'user_mng_proc.php',
            //             type: 'POST',
            //             data: arr,
            //             success: function(result) {
            //                 if(result == 0) {
            //                     $('.error').html('<div><?php //echo $arrTextTranslate['PUBLIC_MSG_004']; ?></div>');
            //                 }
            //                 loadData(1);
            //             },
            //             error: function(e) {
            //                 console.log(e);
            //             }
            //         });
            //     }
            // });
        });

        function loadData(condition) {
            var data = $('.search-form').serializeArray();
            data.push({ name: 'event', value: condition });
            $.ajax({
                url: 'user_mng_proc.php',
                type: 'POST',
                data: data,
                success: function(result) {
                    if(result == 0) {
                        $('.error').html('<div><?php echo $arrTextTranslate['PUBLIC_MSG_001']; ?></div>');
                    }
                    $(".ajax-content").html(result);
                },
                error: function(e) {
                    console.log(e);
                }
            });
        }
    </script>
</body>
</html>
