<?php 
/*
    * @request_view.php
    *
    * @create 2020/03/23 AKB Thang
    */
require_once('common/common.php');
header('Content-type: text/html; charset=utf-8');
header('X-FRAME-OPTIONS: DENY');
//DB接続
if(fncConnectDB() == false){
	$_SESSION['LOGIN_ERROR'] = 'DB接続に失敗しました。';
	header('Location: login.php');
	exit;
}
if(!isset($_SESSION['LOGINUSER_INFO'])){
    echo "
    <script>
        alert('".PUBLIC_MSG_008_JPN . "/" . PUBLIC_MSG_008_ENG."');
        window.location.href = 'login.php';
    </script>
    ";

	exit();
}
fncSessionTimeOutCheck();
$_SESSION['errStr'] = '';
define('SCREEN_NAME', '依頼事項詳細表示画面');
define('SCREEN_NAME_VIEW', '依頼事項詳細表示画面　表示');

$arrUserInfo = unserialize($_SESSION['LOGINUSER_INFO']);

fncWriteLog(
    LogLevel['Info'], 
    LogPattern['View'] , 
    SCREEN_NAME_VIEW . ' (ユーザID = '.$arrUserInfo->strUserID.') '
    .(isset($_SERVER['HTTP_REFERER']) ? $_SERVER['HTTP_REFERER'] : null)
);

// get list text translate
$arrTitle =  array(
    'REQUEST_VIEW_TEXT_001',
    'REQUEST_VIEW_MSG_002',
    'PUBLIC_TEXT_001',
    'PUBLIC_TEXT_002',
    'PUBLIC_TEXT_003',
    'PUBLIC_TEXT_004',
    'PUBLIC_TEXT_005',
    'PUBLIC_BUTTON_002',
    'PUBLIC_BUTTON_003',
    'PUBLIC_MSG_009',
    'REQUEST_VIEW_MSG_001',
);

$arrTextTranslate = getListTextTranslate(
    $arrTitle, 
    $arrUserInfo->intLanguageType
);

//redirect if dont have permission
if($arrUserInfo->intMenuPerm == 0){
    echo "
    <script>
        alert('".$arrTextTranslate['PUBLIC_MSG_009']."');
        window.location.href = 'login.php';
    </script>
    ";
}

if(
    !(!empty($_SERVER['HTTP_X_REQUESTED_WITH']) 
    && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest')
)
{    
    exit;    
}

if(isset($_POST['id'])){
    
    //check request exist
    $arrOneRequest = fncSelectOne(
        "SELECT t_request.* FROM t_request 
        INNER JOIN t_incident_case
        ON t_incident_case.INCIDENT_CASE_NO = t_request.INCIDENT_CASE_NO
        WHERE t_incident_case.COMP_DATE IS NULL
        AND 
        t_request.REQUEST_NO=?", 
        [$_POST['id']], 
        SCREEN_NAME
    );
    if(!is_array($arrOneRequest) || count($arrOneRequest) == 0){
        //log error
        fncWriteLog(
            LogLevel['Error'],
            LogPattern['Error'],
            SCREEN_NAME . ' ' . $arrTextTranslate['REQUEST_VIEW_MSG_002']
        )
        //request not exist
?>
<script>
    alert('<?php echo $arrTextTranslate['REQUEST_VIEW_MSG_002']; ?>');
    $('#myModal').modal('hide');
</script>
<?php
        exit();
    }
    //get user company from request
    $arrUserLogin = fncSelectOne(
        "SELECT COMPANY_NO FROM m_user
        INNER JOIN t_request ON t_request.REG_USER_NO=m_user.USER_NO
        WHERE REQUEST_NO=?",
        [$arrOneRequest['REQUEST_NO']],
        SCREEN_NAME
    );
    if($arrUserInfo->intCompanyNo == $arrUserLogin['COMPANY_NO']){
        $blnEditRequest = true;
    }else{
        $blnEditRequest = false;
    }

?>

<div class="main-content">
    <div class="main-form">
        <div class="form-title">
            <?php echo $arrTextTranslate['REQUEST_VIEW_TEXT_001']; ?>

        </div>
        <div class="edit-error" style="color:red;"></div>
        <div class="form-body">
            <?php if(!$arrOneRequest['CORRECTION_FLAG']){ ?>
            <div class="error-messeage">
                <div><?php echo PUBLIC_TEXT_001_JPN; ?></div>
                <div><?php echo PUBLIC_TEXT_001_ENG; ?></div>
            </div>
            <?php } ?>
            <div class="cont-title">
                <div class="in-lineblock col-left">
                    <div class="title">
                        <?php echo PUBLIC_TEXT_004_JPN; ?>/<?php echo PUBLIC_TEXT_004_ENG; ?>
                    </div>
                    <div class="info">
                        <div class="text-input text-bold">
                            <?php echo fncHtmlSpecialChars($arrOneRequest['TITLE_JPN']); ?>
                        </div>
                        <div class="text-input text-bold">
                            <?php echo fncHtmlSpecialChars($arrOneRequest['TITLE_ENG']); ?>
                        </div>
                    </div>
                </div>
                <?php if($blnEditRequest){ ?>
                    <div class="col-right in-lineblock right-20">
                        <button type="button" class="tbtn tbtn-defaut load-modal" 
                        href="request_edit.php" data-id="<?php echo $_POST['id'];?>" id="btn-edit">
                            <?php echo fncHtmlSpecialChars($arrTextTranslate['PUBLIC_BUTTON_002']) ?>
                        </button>
                    </div>
                <?php } ?>
            </div>

            <div class="title">
                <?php echo PUBLIC_TEXT_005_JPN; ?>/<?php echo PUBLIC_TEXT_005_ENG; ?>
            </div>
            <div class="info">
                <div class="line">
                    <div>
                        (<?php echo PUBLIC_TEXT_002_JPN; ?>/<?php echo PUBLIC_TEXT_002_ENG; ?>)
                    </div>
                    <div class="text-input text-bold">
                        <?php echo fncHtmlSpecialChars($arrOneRequest['CONTENTS_JPN']); ?>
                    </div>
                </div>
            </div>

            <div class="info">
                <div class="line">
                    <div>
                        (<?php echo PUBLIC_TEXT_003_JPN; ?>/<?php echo PUBLIC_TEXT_003_ENG; ?>)
                    </div>
                    <div class="text-input text-bold">
                        <?php echo fncHtmlSpecialChars($arrOneRequest['CONTENTS_ENG']); ?>
                    </div>
                </div>
            </div>
            <div class="link info">
                <?php for($intLoop =1; $intLoop<=5; $intLoop++){ ?>
                    <?php if(isset($arrOneRequest['TMP_FILE_NAME'.$intLoop]) 
                    && trim($arrOneRequest['TMP_FILE_NAME'.$intLoop]) != ''){
                        $strPathTmp = SHARE_FOLDER . '/' . REQUEST_ATTACHMENT_FOLDER . '/' 
                        . $arrOneRequest['REQUEST_NO'] . '/'.$intLoop.'/' 
                        . $arrOneRequest['TMP_FILE_NAME'.$intLoop];
                    }
                    ?>
                    <div>
                        <a <?php echo 'href="#"'
                        . (!file_exists(SHARE_FOLDER . '/' . REQUEST_ATTACHMENT_FOLDER 
                        . '/' . $arrOneRequest['REQUEST_NO'] . '/'.$intLoop.'/' 
                        . $arrOneRequest['TMP_FILE_NAME'.$intLoop]) 
                        ? ' class="no-file"' 
                        : ' onclick="downloadURI(\''.base64_encode($strPathTmp)
                        .'\', \'request_view_proc.php\', \''
                        .$arrTextTranslate['REQUEST_VIEW_MSG_001'].'\')"')
                        ?> >
                            <?php echo $arrOneRequest['TMP_FILE_NAME'.$intLoop]; ?>
                        </a>
                    </div>
                <?php } ?>
            </div>

            <div class="form-footer  text-right top-20">
                <button type="submit" class="tbtn-cancel tbtn-defaut" 
                id="close" data-dismiss="modal">
                    <?php echo $arrTextTranslate['PUBLIC_BUTTON_003'] ?>
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    var fileNotExistMessage = '<?php 
    echo $arrTextTranslate['REQUEST_VIEW_MSG_001'] ?>';
    $('.no-file').click(function(e){
        e.preventDefault();
        $('.edit-error').html(fileNotExistMessage);
    });
</script>
<?php 

}else{
    echo "
    <script>
        alert('".PUBLIC_MSG_008_JPN."/".PUBLIC_MSG_008_ENG."');
        window.location.href = 'login.php';
    </script>
    ";
    exit();
}
?>