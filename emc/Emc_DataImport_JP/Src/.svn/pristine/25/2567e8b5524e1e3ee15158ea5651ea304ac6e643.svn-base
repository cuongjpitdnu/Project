<?php
    /*
	* @company_edit_proc.php
	*
	* @create 2020/03/13 AKB Thang
	*/
    
    require_once('common/common.php');
    require_once('common/session_check.php');
    header('Content-type: text/html; charset=utf-8');
    header('X-FRAME-OPTIONS: DENY');

    if(fncConnectDB() == false) {
        $_SESSION['LOGIN_ERROR'] = 'DB接続に失敗しました。';
        header('Location: login.php');
        exit;
    }
    if(!isset($_SESSION['LOGINUSER_INFO'])) {
        echo "
        <script>
            alert('".PUBLIC_MSG_008_JPN . "/" . PUBLIC_MSG_008_ENG."');
            window.location.href = 'login.php';
        </script>
        ";
        exit();
    }
    //sesstion check
    fncSessionTimeOutCheck(1);
    //if request is not ajax -> stop
    if(
        !(!empty($_SERVER['HTTP_X_REQUESTED_WITH']) 
        && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest')
    )
    {    
        exit;    
    }
    $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] = '';
    define('SCREEN_NAME', '会社情報新規登録・編集画面');
    $arrUserInfo = unserialize($_SESSION['LOGINUSER_INFO']);
    // get list text translate
    $arrTitle =  array(
        'COMPANY_EDIT_MSG_002',
        'COMPANY_EDIT_MSG_003',
        'COMPANY_EDIT_MSG_004',
        'COMPANY_EDIT_MSG_005',
        'COMPANY_EDIT_MSG_006',
        'COMPANY_EDIT_MSG_007',
        'COMPANY_EDIT_MSG_008',
        'COMPANY_EDIT_MSG_009',
        'COMPANY_EDIT_MSG_010',
        'COMPANY_EDIT_MSG_011',
        'COMPANY_EDIT_MSG_012',
        'COMPANY_EDIT_MSG_013',
        'PUBLIC_MSG_009',
        'PUBLIC_MSG_003',
        'PUBLIC_MSG_002',
        'COMPANY_EDIT_MSG_014',
    );

    $arrTextTranslate = getListTextTranslate(
        $arrTitle, 
        $arrUserInfo->intLanguageType
    );

    

    //redirect if dont have permission
    if($arrUserInfo->intMenuPerm != 1) {
        echo "
        <script>
            alert('".$arrTextTranslate['PUBLIC_MSG_009']."');
            window.location.href = 'login.php';
        </script>
        ";
        exit();
    }

    //check input
    define('COMPANY_NAME_JPN_LENGTH', 20);
    define('COMPANY_NAME_ENG_LENGTH', 50);
    define('ABBREVIATIONS_JPN_LENGTH', 4);
    define('ABBREVIATIONS_ENG_LENGTH', 4);
    

    if(isset($_POST['company_no'])) {
        $objOne = fncSelectOne(
            "SELECT COMPANY_NO FROM m_company WHERE COMPANY_NO=?", 
            [$_POST['company_no']], 
            SCREEN_NAME
        );
        if(!$objOne && $_POST['company_no'] != '') {
            $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
            .= $arrTextTranslate['PUBLIC_MSG_003'].'<br>';
        } else {
            if(!isset($_POST['company_name_jpn']) 
            || mb_strlen($_POST['company_name_jpn']) == 0) {
                $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
                .= $arrTextTranslate['COMPANY_EDIT_MSG_002'].'<br>';
            } else {
                //　文字数 > 20
                if(mb_strlen($_POST['company_name_jpn'])>COMPANY_NAME_JPN_LENGTH) {
                    $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
                    .= $arrTextTranslate['COMPANY_EDIT_MSG_003'].'<br>';
                }
            }

            if(!isset($_POST['company_name_eng'])
            || mb_strlen($_POST['company_name_eng']) == 0) {
                $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
                .= $arrTextTranslate['COMPANY_EDIT_MSG_004'].'<br>';
            } else {
                //　文字数 > 50
                if(mb_strlen($_POST['company_name_eng'])>COMPANY_NAME_ENG_LENGTH) {
                    $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
                    .= $arrTextTranslate['COMPANY_EDIT_MSG_005'].'<br>';
                }

                //　「半角英数字または特殊文字」以外
                if(!fncCheckEngText($_POST['company_name_eng'])) {
                    $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
                    .= $arrTextTranslate['COMPANY_EDIT_MSG_006'].'<br>';
                }
            }

            if(!isset($_POST['abbreviations_jpn']) 
            || mb_strlen($_POST['abbreviations_jpn']) == 0){
                $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
                .= $arrTextTranslate['COMPANY_EDIT_MSG_007'].'<br>';
            } else {
                //　文字数 >  4
                if(mb_strlen($_POST['abbreviations_jpn'])>ABBREVIATIONS_JPN_LENGTH) {
                    $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
                    .= $arrTextTranslate['COMPANY_EDIT_MSG_008'].'<br>';
                }
            }

            if(!isset($_POST['abbreviations_eng']) 
            || mb_strlen($_POST['abbreviations_eng']) == 0) {
                $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
                .= $arrTextTranslate['COMPANY_EDIT_MSG_009'].'<br>';
            } else {
                //　文字数 >  4
                if(mb_strlen($_POST['abbreviations_eng'])>ABBREVIATIONS_ENG_LENGTH) {
                    $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
                    .= $arrTextTranslate['COMPANY_EDIT_MSG_010'].'<br>';
                }
                //　「半角英数字または特殊文字」以外
                if(!fncCheckEngText($_POST['abbreviations_eng'])) {
                    $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
                    .= $arrTextTranslate['COMPANY_EDIT_MSG_011'].'<br>';
                }
            }
            //　inst categoryが存在しない場合
            if(!isset($_POST['inst_category_no']) || $_POST['inst_category_no'] == '') {
                $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
                .= $arrTextTranslate['COMPANY_EDIT_MSG_012'].'<br>';
            }

            if(!isset($_POST['group_no']) || $_POST['group_no'] == '') {
                $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
                .= $arrTextTranslate['COMPANY_EDIT_MSG_013'].'<br>';
            }
        }
    } else {
        $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] 
        .= $arrTextTranslate['COMPANY_EDIT_MSG_014'];
    }
    if($_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT'] != '') {
    //show error message
?>
$('.edit-error').html('<?php echo $_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT']; ?>');
<?php
        unset($_SESSION['COMPANY_EDIT_MSG_ERROR_INPUT']);
    } else {
        //process
        try {
            $arrInstCategoryList = fncSelectOne("SELECT INST_CATEGORY_NO
                FROM m_inst_category
                WHERE INST_CATEGORY_NO=?",
                [$_POST['inst_category_no']], SCREEN_NAME);
            $arrGroupList = fncSelectOne("SELECT GROUP_NO
                FROM m_group
                WHERE GROUP_NO=?",
                [$_POST['group_no']], SCREEN_NAME);

            if($_POST['company_no'] != '') {
                //update company
                if(!$arrInstCategoryList || !$arrGroupList) {
                    // inst category又はgroupデータが存在しない場合、ログを出力し、エラーメッセージを表示する
                    fncWriteLog(
                        LogLevel['Error'], 
                        LogPattern['Error'], 
                        $arrTextTranslate['PUBLIC_MSG_003']
                    );
                    echo "$('.edit-error').html('".$arrTextTranslate['PUBLIC_MSG_003']."');";
                    exit();
                }
                $objResult = fncProcessData(
                    [
                        'COMPANY_NO' => $_POST['company_no'],
                        'COMPANY_NAME_JPN'  => $_POST['company_name_jpn'],
                        'COMPANY_NAME_ENG'  =>  $_POST['company_name_eng'],
                        'ABBREVIATIONS_JPN'  => $_POST['abbreviations_jpn'],
                        'ABBREVIATIONS_ENG'  => $_POST['abbreviations_eng'],
                        'ABBREVIATIONS_ENG'  => $_POST['abbreviations_eng'],
                        'INST_CATEGORY_NO'  => $_POST['inst_category_no'],
                        'GROUP_NO'  => $_POST['group_no']
                    ], 
                    'm_company', 
                    'COMPANY_NO=?', 
                    array($_POST['company_no']), 
                    SCREEN_NAME
                );
                if(is_object($objResult) && $objResult->rowCount()>0){
                    //　会社情報を保存する処理にエラーがない場合、ログ出力する
                    echo 0;
                    fncWriteLog(
                        LogLevel['Info'], 
                        LogPattern['Button'], 
                        SCREEN_NAME . ' 登録 (ユーザID = '.$arrUserInfo->strUserID.')'
                    );
                    
                } else {
                    //　会社情報を保存する処理にエラーがある場合
                    fncWriteLog(
                        LogLevel['Error'], 
                        LogPattern['Error'], 
                        $arrTextTranslate['PUBLIC_MSG_003']
                    );
                    echo "$('.edit-error').html('".$arrTextTranslate['PUBLIC_MSG_003']."');";
                }
            } else {

                //　新規登録処理
                if(!$arrInstCategoryList || !$arrGroupList) {
                    //　inst category又はgroupデータが存在しない場合、ログを出力し、エラーメッセージを表示する
                    fncWriteLog(
                        LogLevel['Error'], 
                        LogPattern['Error'], 
                        $arrTextTranslate['PUBLIC_MSG_002']
                    );
                    echo "$('.edit-error').html('".$arrTextTranslate['PUBLIC_MSG_002']."');";
                    exit();
                }
                //get int company no
                $objLastCompany = fncSelectOne(
                    "SELECT COMPANY_NO FROM m_company ORDER BY COMPANY_NO DESC", 
                    [], 
                    SCREEN_NAME
                );
                if($objLastCompany) {
                    $intCompanyNo = $objLastCompany['COMPANY_NO'] + 1;
                } else {
                    $intCompanyNo = 1;
                }
                //get int sort no
                $objLastSortCompany = fncSelectOne(
                    "SELECT SORT_NO FROM m_company ORDER BY SORT_NO DESC", 
                    [], 
                    SCREEN_NAME
                );
                if($objLastSortCompany){
                    $intSortNo = $objLastSortCompany['SORT_NO'] + 1;
                }else{
                    $intSortNo = 1;
                }

                $objResult = fncProcessData([
                    'COMPANY_NO' => $intCompanyNo,
                    'COMPANY_NAME_JPN'  => $_POST['company_name_jpn'],
                    'COMPANY_NAME_ENG'  =>  $_POST['company_name_eng'],
                    'ABBREVIATIONS_JPN'  => $_POST['abbreviations_jpn'],
                    'ABBREVIATIONS_ENG'  => $_POST['abbreviations_eng'],
                    'ABBREVIATIONS_ENG'  => $_POST['abbreviations_eng'],
                    'INST_CATEGORY_NO'  => $_POST['inst_category_no'],
                    'GROUP_NO'  => $_POST['group_no'],
                    'SORT_NO'   =>  $intSortNo,
                    'DEL_FLAG'  =>  0
                ], 'm_company', '', array(), SCREEN_NAME);
                if(is_object($objResult) && $objResult->rowCount()>0){
                    //　会社情報を保存する処理にエラーがある場合
                    echo 1;
                    fncWriteLog(
                        LogLevel['Info'], 
                        LogPattern['Button'], 
                        SCREEN_NAME . ' 更新 (ユーザID = '.$arrUserInfo->strUserID.')'
                    );
                    
                } else {
                    //　会社情報を保存する処理にエラーがある場合
                    fncWriteLog(
                        LogLevel['Error'], 
                        LogPattern['Error'], 
                        SCREEN_NAME . ' 更新 ' . $arrTextTranslate['PUBLIC_MSG_002']
                    );
                    echo "$('.edit-error').html('".$arrTextTranslate['PUBLIC_MSG_002']."');";
                }
            }
        } catch(\Exception $e) {
            fncWriteLog(
                LogLevel['Error'], 
                LogPattern['Error'],
                $e->getMessage()
            );
            echo $e->getMessage();
        }
    }
?>