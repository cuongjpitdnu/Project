<?php
require_once('common/common.php');
header('Content-type: text/html; charset=utf-8');
header('X-FRAME-OPTIONS: DENY');
//DB接続
if(fncConnectDB() == false) {
	echo "
    <script>
        alert('".PUBLIC_MSG_008_JPN . "/" . PUBLIC_MSG_008_ENG."');
        window.location.href = 'login.php';
    </script>
    ";
	exit();
}
if(!isset($_SESSION['LOGINUSER_INFO'])) {
    echo "
    <script>
        alert('".PUBLIC_MSG_008_JPN . "/" . PUBLIC_MSG_008_ENG."');
        window.location.href = 'login.php';
    </script>
    ";
	exit();
}
$_SESSION['errStr'] = '';

$userInfo = unserialize($_SESSION['LOGINUSER_INFO']);

// get list text translate
$arrTitle =  array(
    'COMPANY_EDIT_TEXT_001',
    'COMPANY_EDIT_TEXT_002',
    'COMPANY_EDIT_TEXT_003',
    'COMPANY_EDIT_TEXT_004',
    'COMPANY_EDIT_TEXT_005',
    'COMPANY_EDIT_TEXT_006',
    'COMPANY_EDIT_TEXT_007',

    'PUBLIC_BUTTON_003',
    'PUBLIC_BUTTON_013',
    'PUBLIC_MSG_001',
    'PUBLIC_MSG_008',
    'PUBLIC_MSG_009',
    'PUBLIC_MSG_004',
    'COMPANY_EDIT_MSG_014',
    'COMPANY_EDIT_MSG_001',
);

$arrTextTranslate = getListTextTranslate($arrTitle, $userInfo->intLanguageType);

fncWriteLog(LogLevel['Info'] , LogPattern['View'] , '会社情報新規登録・編集画面 表示 (ユーザID = '.$userInfo->strUserID.')');

$user = fncSelectOne("SELECT USER_NO FROM m_user WHERE USER_NO = ?", [$userInfo->intUserNo], '会社情報新規登録・編集画面');
if(!$user) {
    echo "
    <script>
        alert('".$arrTextTranslate['PUBLIC_MSG_008']."');
        window.location.href = 'login.php';
    </script>
    ";
	exit();
}

//redirect if dont have permission
if($userInfo->intMenuPerm != 1) {
    echo "
    <script>
        alert('".$arrTextTranslate['PUBLIC_MSG_009']."');
        window.location.href = 'login.php';
    </script>
    ";
}

if(isset($_POST['id'])) {
    if($_POST['id'] != 0) {
        //process edit company
        $row = fncSelectOne("SELECT * FROM m_company WHERE COMPANY_NO=?", [$_POST['id']], '会社情報新規登録・編集画面');
        if(!$row) {
            // print_r($row);
            //company not exist, return error msg
            $errMsg = $arrTextTranslate['COMPANY_EDIT_MSG_014'];
?>
    <script>
        alert('<?php echo $errMsg; ?>');
        $('#myModal').modal('hide');
    </script>
<?php
            exit();
        }
    }
    // print_r($row);
    //continue to edit company

    //get inst cats
    $strSQL = "SELECT INST_CATEGORY_NO,";
    $strSQL .= iff($userInfo->intLanguageType, " INST_CATEGORY_NAME_ENG as INST_CATEGORY_NAME,", " INST_CATEGORY_NAME_JPN as INST_CATEGORY_NAME,");
    $strSQL .= " INST_CATEGORY_NAME_ENG,";
    $strSQL .= " INST_CATEGORY_NAME_JPN,";
    $strSQL .= " SORT_NO";
    $strSQL .= " FROM m_inst_category ORDER BY SORT_NO ASC";

    $instCats = fncSelectData($strSQL, [], 1, false, '会社情報新規登録・編集画面');

    // print_r($instCats);
    //get m_groups
    $strSQL = "SELECT GROUP_NO,";
    $strSQL .= iff($userInfo->intLanguageType, " GROUP_NAME_ENG as GROUP_NAME,", " GROUP_NAME_JPN as GROUP_NAME,");
    $strSQL .= " GROUP_NAME_ENG,";
    $strSQL .= " GROUP_NAME_JPN,";

    $strSQL .= " SORT_NO";
    $strSQL .= " FROM m_group ORDER BY SORT_NO ASC";

    $groups = fncSelectData($strSQL, [], 1, false, '会社情報新規登録・編集画面');
    // print_r($groups);
?>
<div class="main-content">
    <div class="main-form">
        <div class="form-title"><?php echo $arrTextTranslate['COMPANY_EDIT_TEXT_001']; ?></div>
        <div class="edit-error" style="color:red;"></div>
        <div class="form-body-90">
            <form class="formEdit" action="company_edit_proc.php">
            <input type="hidden" name="company_no" value="<?php if(isset($row['COMPANY_NO'])) echo $row['COMPANY_NO']; ?>">
            <input type="hidden" name="X-CSRF-TOKEN" value="<?php if(isset($_SESSION['csrf'])) echo $_SESSION['csrf']; ?>">
            <div class="label-short"><?php echo $arrTextTranslate['COMPANY_EDIT_TEXT_002']; ?> <span class="txt-red">※</span></div>
            <input type="text" name="company_name_jpn" class="t-input t-input-250" value="<?php if(isset($row['COMPANY_NAME_JPN'])) echo fncHtmlSpecialChars($row['COMPANY_NAME_JPN']); ?>"><br/>

            <div class="label-short"><?php echo $arrTextTranslate['COMPANY_EDIT_TEXT_003']; ?> <span class="txt-red">※</span></div>
            <input type="text" name="company_name_eng" class="t-input t-input-250" value="<?php if(isset($row['COMPANY_NAME_ENG'])) echo fncHtmlSpecialChars($row['COMPANY_NAME_ENG']); ?>"><br/>

            <div class="label-short"><?php echo $arrTextTranslate['COMPANY_EDIT_TEXT_004']; ?> <span class="txt-red">※</span></div>
            <input type="text" name="abbreviations_jpn" class="t-input" value="<?php if(isset($row['ABBREVIATIONS_JPN'])) echo fncHtmlSpecialChars($row['ABBREVIATIONS_JPN']); ?>"><br/>
            <div class="label-short"><?php echo $arrTextTranslate['COMPANY_EDIT_TEXT_005']; ?> <span class="txt-red">※</span></div>
            <input type="text" name="abbreviations_eng" class="t-input t-input-250" value="<?php if(isset($row['ABBREVIATIONS_ENG'])) echo fncHtmlSpecialChars($row['ABBREVIATIONS_ENG']); ?>"><br/>

            <div class="label-short"><?php echo $arrTextTranslate['COMPANY_EDIT_TEXT_006']; ?><span class="txt-red">※</span></div>
            <div class="select-container">
                <select name="inst_category_no">
                <?php echo (!isset($row['COMPANY_NO']) ? '<option value=""></option>' : ''); ?>">
                <?php if(isset($instCats)) foreach($instCats as $instCat) {
                    echo '<option value="'.$instCat['INST_CATEGORY_NO'].'" '.(isset($row['INST_CATEGORY_NO']) && $row['INST_CATEGORY_NO'] == $instCat['INST_CATEGORY_NO'] ? 'selected' : '').'>'.fncHtmlSpecialChars($instCat['INST_CATEGORY_NAME']).'</option>';
                }?>
                </select>
            </div><br/>

            <div class="label-short"><?php echo $arrTextTranslate['COMPANY_EDIT_TEXT_007']; ?> <span class="txt-red">※</span></div>
            <div class="select-container">
                <select name="group_no">
                <?php echo (!isset($row['COMPANY_NO']) ? '<option value=""></option>' : ''); ?>">
                <?php if(isset($groups)) foreach($groups as $group) {
                    echo '<option value="'.$group['GROUP_NO'].'" '.(isset($row['GROUP_NO']) && $row['GROUP_NO'] == $group['GROUP_NO'] ? 'selected' : '').'>'.fncHtmlSpecialChars($group['GROUP_NAME']).'</option>';
                }?>
                </select>
            </div>

            <div class="form-footer top-20 text-right">
                <button type="submit" class="tbtn tbtn-defaut btn-save-edit" ><?php echo $arrTextTranslate['PUBLIC_BUTTON_013']; ?></button>
                <button type="submit" class="tbtn-cancel tbtn-defaut " id="close-setting" data-dismiss="modal"><?php echo $arrTextTranslate['PUBLIC_BUTTON_003']; ?></button>
            </div>
            </form>
        </div>
    </div>
</div>
<script>
    var confirmMsg = '<?php echo $arrTextTranslate['COMPANY_EDIT_MSG_001']; ?>'
</script>
<?php
} else {
    echo "
    <script>
        alert('".PUBLIC_MSG_008_JPN."');
        window.location.href = 'login.php';
    </script>
    ";
    exit();
}
?>