<?php 

require_once('common/common.php');
header('Content-type: text/html; charset=utf-8');
header('X-FRAME-OPTIONS: DENY');
//DB接続
if(fncConnectDB() == false){
	echo "
    <script>
        alert('".PUBLIC_MSG_008_JPN . "/" . PUBLIC_MSG_008_ENG."');
        window.location.href = 'login.php';
    </script>
    ";
	exit();
}
if(!isset($_SESSION['LOGINUSER_INFO'])){
    echo "
    <script>
        alert('".PUBLIC_MSG_008_JPN . "/" . PUBLIC_MSG_008_ENG."');
        window.location.href = 'login.php';
    </script>
    ";

	exit();
}
$_SESSION['errStr'] = '';

$userInfo = unserialize($_SESSION['LOGINUSER_INFO']);

fncWriteLog(LogLevel['Info'] , LogPattern['View'] , 'ユーザ登録編集画面 表示  (ユーザID = '.$userInfo->strUserID.')');

// get list text translate
$arrTitle =  array(
    'USER_EDIT_TEXT_001',
    'USER_EDIT_TEXT_002',
    'USER_EDIT_TEXT_003',
    'USER_EDIT_TEXT_004',
    'USER_EDIT_TEXT_005',

    'PUBLIC_TEXT_006',
    'PUBLIC_TEXT_007',

    'USER_EDIT_TEXT_006',
    'USER_EDIT_TEXT_007',
    'USER_EDIT_TEXT_008',
    'USER_EDIT_TEXT_009',
    'USER_EDIT_TEXT_010',
    'USER_EDIT_TEXT_011',
    'USER_EDIT_TEXT_012',
    'USER_EDIT_TEXT_013',
    'USER_EDIT_TEXT_014',
    'USER_EDIT_TEXT_015',
    'USER_EDIT_TEXT_016',
    'USER_EDIT_TEXT_017',

    'PUBLIC_BUTTON_003',
    'PUBLIC_BUTTON_013',

    'USER_EDIT_MSG_001',
    'PUBLIC_MSG_009',
    'PUBLIC_MSG_001',


    
);

$arrTextTranslate = getListTextTranslate($arrTitle, $userInfo->intLanguageType);




$user = fncSelectOne("SELECT USER_NO FROM m_user WHERE USER_NO=?",
    [$userInfo->intUserNo], 'ユーザ登録編集画面');
if(!$user){
    echo "
    <script>
        alert('".$arrTextTranslate['PUBLIC_MSG_008']."');
        window.location.href = 'login.php';
    </script>
    ";

	exit();
}

//redirect if dont have permission
if($userInfo->intMenuPerm == 0){
    echo "
    <script>
        alert('".$arrTextTranslate['PUBLIC_MSG_009']."');
        window.location.href = 'login.php';
    </script>
    ";
}


if(isset($_POST['id'])){
    if($_POST['id'] != 0){
        //process edit company
        $row = fncSelectOne("SELECT * FROM m_user WHERE USER_NO=?", [$_POST['id']], 'ユーザ登録編集画面');
        if(!$row){
            // print_r($row);
            //user not exist, return error msg
            $errMsg = $arrTextTranslate['PUBLIC_MSG_001'];

?>
    <script>
        alert('<?php echo $errMsg; ?>');

        $('#myModal').modal('hide');

    </script>


<?php
            exit();
        }
    }
    // print_r($row);
            //continue to edit company
            
    //get company 
    $strSQL = "SELECT COMPANY_NO,";
    $strSQL .= iff($userInfo->intLanguageType, " COMPANY_NAME_ENG as COMPANY_NAME,", " COMPANY_NAME_JPN as COMPANY_NAME,");
    $strSQL .= " COMPANY_NAME_ENG,";
    $strSQL .= " COMPANY_NAME_JPN,";
    $strSQL .= " SORT_NO";
    $strSQL .= " FROM m_company ORDER BY SORT_NO ASC";

    $companies = fncSelectData($strSQL, [], 1, false, 'ユーザ登録編集画面');
?>

<div class="main-content">
    <div class="main-form">
        <div class="form-title"><?php echo $arrTextTranslate['USER_EDIT_TEXT_001']; ?></div>
        <div class="edit-error" style="color:red;"></div>
        <div class="form-body">
        <form class="formEdit" action="user_edit_proc.php">
            <div class="clearfix">
            
                <div class="in-line tcol-md-6 " style="float: left">
                    
                    <div class="label-short"><?php echo $arrTextTranslate['USER_EDIT_TEXT_002']; ?> <span class="txt-red">※</span></div>
                    <input type="hidden" name="mode" class="t-input t-input-250" value="1">
                    <input type="hidden" name="user_no" class="t-input t-input-250" value="<?php if(isset($row['USER_NO'])) echo $row['USER_NO']; ?>">
                    <input type="hidden" name="X-CSRF-TOKEN" value="<?php if(isset($_SESSION['csrf'])) echo $_SESSION['csrf']; ?>">
                    <input type="text"  name="user_id" class="t-input t-input-250" value="<?php if(isset($row['USER_ID'])) echo $row['USER_ID']; ?>"  <?php if(isset($row['USER_NO'])) echo 'disabled'; ?>><br/>

                    <div class="label-short"><?php echo $arrTextTranslate['USER_EDIT_TEXT_004']; ?> <span class="txt-red">※</span></div>
                    <input type="text" name="expiration_date_s" class="t-input t-input-115" id="date_start" value="<?php if(isset($row['EXPIRATION_DATE_S'])) echo date_format(date_create($row['EXPIRATION_DATE_S']), 'Y/m/d'); ?>"> ~
                    <input type="text" name="expiration_date_e" class="t-input t-input-115" id="date_end" value="<?php if(isset($row['EXPIRATION_DATE_E'])) echo date_format(date_create($row['EXPIRATION_DATE_E']), 'Y/m/d'); ?>"><br/>

                    <div class="label-short"><?php echo $arrTextTranslate['USER_EDIT_TEXT_006']; ?> <span class="txt-red">※</span></div>
                    <div class="select-container">
                        <select name="company_no">
                            <?php echo (!isset($row['USER_NO']) ? '<option value=""></option>' : ''); ?>
                            <?php if(isset($companies)) foreach($companies as $company){?>
                            <option value="<?php echo $company['COMPANY_NO']; ?>" <?php echo (isset($row['COMPANY_NO']) && $row['COMPANY_NO']==$company['COMPANY_NO'] ? 'selected' : ''); ?>><?php echo $company['COMPANY_NAME']; ?></option>
                            <?php } ?>
                        </select>
                    </div><br/>

                    <div class="label-short"><?php echo $arrTextTranslate['USER_EDIT_TEXT_009']; ?></div>
                    <input type="text"  name="organization" class="t-input t-input-250" value="<?php if(isset($row['ORGANIZATION'])) echo $row['ORGANIZATION']; ?>"><br/>

                    <div class="label-short"><?php echo $arrTextTranslate['USER_EDIT_TEXT_011']; ?></div>
                    <input type="text" name="user_name" class="t-input t-input-250" value="<?php if(isset($row['USER_NAME'])) echo $row['USER_NAME']; ?>"><br/>

                    <div class="label-short"><?php echo $arrTextTranslate['USER_EDIT_TEXT_013']; ?></div>
                    <input type="text" name="tel" class="t-input t-input-250" value="<?php if(isset($row['TEL'])) echo $row['TEL']; ?>"><br/>
                </div>

                <div class="in-line tcol-md-6">
                    <div class="label-short"><?php echo $arrTextTranslate['USER_EDIT_TEXT_003']; ?> <span class="txt-red">※</span></div>
                    <input  name="password"  type="password" class="t-input t-input-250" value="<?php if(isset($row['PASSWORD'])) echo $row['PASSWORD']; ?>"><br/>

                    <div class="cont-radio">
                        <div class="label-short"><?php echo $arrTextTranslate['USER_EDIT_TEXT_005']; ?> <span class="txt-red">※</span></div>
                        <label class="container-radio"><?php echo $arrTextTranslate['PUBLIC_TEXT_006']; ?>
                            <input type="radio" name="language_type" value="0" <?php echo (isset($row['LANGUAGE_TYPE']) && $row['LANGUAGE_TYPE']==0 ? 'checked': '') ?>>
                            <span class="checkmark checkmark-radio"></span>
                        </label>
                        <label class="container-radio"><?php echo $arrTextTranslate['PUBLIC_TEXT_007']; ?>
                            <input type="radio" name="language_type" value="1" <?php echo (isset($row['LANGUAGE_TYPE']) && $row['LANGUAGE_TYPE']==1 ? 'checked' : '') ?>>
                            <span class="checkmark checkmark-radio"></span>
                        </label><br/>
                    </div>
                    <?php          
                        if(isset($row['COMPANY_NO']))
                        $one = fncSelectOne("SELECT
                        ".iff($userInfo->intLanguageType, ' m_company.ABBREVIATIONS_ENG as abbreviations,', ' m_company.ABBREVIATIONS_JPN as abbreviations,')."
                        ".iff($userInfo->intLanguageType, ' m_inst_category.INST_CATEGORY_NAME_ENG as INST_CATEGORY_NAME,', ' m_inst_category.INST_CATEGORY_NAME_JPN as INST_CATEGORY_NAME,')."
                        ".iff($userInfo->intLanguageType, ' m_group.GROUP_NAME_ENG as GROUP_NAME', ' m_group.GROUP_NAME_JPN as GROUP_NAME')."
                        FROM m_company
                        LEFT JOIN m_inst_category ON m_inst_category.INST_CATEGORY_NO = m_company.INST_CATEGORY_NO
                        LEFT JOIN m_group ON m_group.GROUP_NO = m_company.GROUP_NO
                        WHERE COMPANY_NO=?"
                        , [$row['COMPANY_NO']], 'ユーザ登録編集画面');
                    
                    ?>
                    <div class="in-line">
                        <div class="label-short"><?php echo $arrTextTranslate['USER_EDIT_TEXT_007']; ?></div>
                        <input type="text" class="t-input t-input-60" id="aj1" value="<?php if(isset($one['abbreviations'])) echo $one['abbreviations'] ?>" disabled>
                    </div>
                    
                    <div class="in-line">
                        <div class="label-100"><?php echo $arrTextTranslate['USER_EDIT_TEXT_008']; ?></div>
                        <input type="text" class="t-input" id="aj2" value="<?php if(isset($one['INST_CATEGORY_NAME'])) echo $one['INST_CATEGORY_NAME'] ?>" style="width: 78px" disabled><br/>
                    </div>

                    <div class="label-short"><?php echo $arrTextTranslate['USER_EDIT_TEXT_010']; ?> <span class="txt-red">※</span></div>
                    <input type="text" class="t-input t-input-250" id="aj3" value="<?php if(isset($one['GROUP_NAME'])) echo $one['GROUP_NAME'] ?>" disabled><br/>

                    <div class="label-short"><?php echo $arrTextTranslate['USER_EDIT_TEXT_012']; ?> <span class="txt-red">※</span></div>
                    <input type="text" name="mail_address" class="t-input t-input-250" value="<?php if(isset($row['MAIL_ADDRESS'])) echo $row['MAIL_ADDRESS']; ?>"><br/>

                    <div class="label-short"><?php echo $arrTextTranslate['USER_EDIT_TEXT_014']; ?></div>
                    <input type="text" name="fax" class="t-input t-input-250" value="<?php if(isset($row['FAX'])) echo $row['FAX']; ?>"><br/>
                </div>
            
            </div>


            <div class="label-short"><?php echo $arrTextTranslate['USER_EDIT_TEXT_015']; ?></div>
            <input type="text" name="zip_code" class="t-input t-input-250" value="<?php if(isset($row['ZIP_CODE'])) echo $row['ZIP_CODE']; ?>"><br/>

            <div>
                <div class="lb-left" style="width: 144px;margin: 10px;"><?php echo $arrTextTranslate['USER_EDIT_TEXT_016']; ?></div>
                <textarea class="t-input"  name="address" rows="2" cols="100"><?php if(isset($row['ADDRESS'])) echo $row['ADDRESS']; ?></textarea><br/>
                <div class="lb-left" style="width: 144px;margin: 10px;"><?php echo $arrTextTranslate['USER_EDIT_TEXT_017']; ?></div>
                <textarea class="t-input"  name="remarks" rows="2" cols="100"><?php if(isset($row['REMARKS'])) echo $row['REMARKS']; ?></textarea>
            </div>

            <div class="form-footer text-right right-20">
                <button type="submit" class="tbtn-cancel tbtn-defaut btn-save-edit"><?php echo $arrTextTranslate['PUBLIC_BUTTON_013']; ?></button>
                <button type="submit" class="tbtn-cancel tbtn-defaut " id="close-setting" data-dismiss="modal"><?php echo $arrTextTranslate['PUBLIC_BUTTON_003']; ?></button>
            </div>
        </form>
        </div>
    </div>
</div>

<script>
    $('#date_start').datepicker({
        changeMonth: true,
        changeYear: true,
        showButtonPanel: true,
        dateFormat: 'yy/mm/dd'
    });

    $('#date_end').datepicker({
        changeMonth: true,
        changeYear: true,
        showButtonPanel: true,
        dateFormat: 'yy/mm/dd'
    });
    $('[name=company_no]').change(function(){
        var compay_no = $(this).val();
        // console.log(compay_no);
        $.ajax({
			url: 'user_edit_proc.php',
			type: 'post',
			data: [
				{name: 'X-CSRF-TOKEN', value: '<?php if(isset($_SESSION['csrf'])) echo $_SESSION['csrf']; ?>'},
				{name: 'mode', value: 2},
				{name: 'company_no', value: compay_no}
            ],
            dataType: 'json',
			success: function(result){
                console.log(result);
                // var arr = JSON.parse(result);
                var arr = result;
                $('#aj1').val(arr[0]);
                $('#aj2').val(arr[1]);
                $('#aj3').val(arr[2]);
                
				
			}
		});
    });
</script>
<script>
    var confirmMsg = '<?php echo $arrTextTranslate['USER_EDIT_MSG_001']; ?>'
</script>
<?php 

}else{
    echo "
    <script>
        alert('".PUBLIC_MSG_008_JPN."/".PUBLIC_MSG_008_ENG."');
        window.location.href = 'login.php';
    </script>
    ";
    exit();
}
?>