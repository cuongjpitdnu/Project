<?php
    /*
     * @bulletin_board_view.php
     *
     * @create 2020/03/24 AKB Chien
     * @update
     */
    require_once('common/common.php');
    require_once('common/session_check.php');

    header('Content-type: text/html; charset=utf-8');
    header('X-FRAME-OPTIONS: DENY');

    define('DISPLAY_TITLE', '掲示板表示画面');

    if(fncConnectDB() == false) {
        $_SESSION['LOGIN_ERROR'] = 'DB接続に失敗しました。';
        header('Location: login.php');
        exit;
    }

    if(!isset($_SESSION['LOGINUSER_INFO'])) {
        $strShow = '<script>alert("'.PUBLIC_MSG_008_JPN.' / '.PUBLIC_MSG_008_ENG.'");';
        $strShow .= ' window.location.href="login.php";</script> ';
        echo $strShow;
        exit;
    }

    fncSessionTimeOutCheck();

    // ログインユーザ情報を取得
    $objLoginUserInfo = unserialize($_SESSION['LOGINUSER_INFO']);

    $intLanguageType = $objLoginUserInfo->intLanguageType;

    $arrTitleMsg =  array(
        'BULLETIN_BOARD_VIEW_TEXT_001',
        'PUBLIC_TEXT_001',
        'BULLETIN_BOARD_VIEW_TEXT_002',
        'BULLETIN_BOARD_VIEW_TEXT_003',
        'PUBLIC_TEXT_002',
        'PUBLIC_TEXT_003',
        'BULLETIN_BOARD_VIEW_TEXT_004',
        'PUBLIC_TEXT_002',
        'PUBLIC_TEXT_003',
        'BULLETIN_BOARD_VIEW_TEXT_005',
        'PUBLIC_TEXT_002',
        'PUBLIC_TEXT_003',
        'PUBLIC_BUTTON_002',
        'PUBLIC_BUTTON_003',
        'BULLETIN_BOARD_VIEW_MSG_001'
    );

    // write log when access this screen
    $strLog = DISPLAY_TITLE.'　表示(ユーザID = '.$objLoginUserInfo->strUserID.') ';
    $strLog .= isset($_SERVER['HTTP_REFERER']) ? $_SERVER['HTTP_REFERER'] : null;
    fncWriteLog(LogLevel['Info'], LogPattern['View'], $strLog);

    // get list text translate
    $arrTxtTrans = getListTextTranslate($arrTitleMsg, $intLanguageType);

    $intId = @$_POST['id'] ? $_POST['id'] : '';

    $arrResult = array(
        'BULLETIN_BOARD_NO' => '',
        'OCCURRENCE_DATE' => '',
        'CORRECTION_FLAG' => '',
        'BUSINESS_NAME' => '',
        'BUSINESS_NAME_ENG' => '',
        'INCIDENT_NAME_JPN' => '',
        'INCIDENT_NAME_ENG' => '',
        'PLACE_NAME' => '',
        'PLACE_NAME_ENG' => '',
    );

    $arrDataDetail = getInfoBullentin($intId);
    // prepare data to show
    if($arrDataDetail != 0 && count($arrDataDetail) > 0) {
        $arrResult = array(
            'BULLETIN_BOARD_NO' => isset($arrDataDetail[0]['BULLETIN_BOARD_NO'])
                                ? $arrDataDetail[0]['BULLETIN_BOARD_NO'] : '',
            'OCCURRENCE_DATE' => isset($arrDataDetail[0]['OCCURRENCE_DATE'])
                                ? fncHtmlSpecialChars(trim($arrDataDetail[0]['OCCURRENCE_DATE'])) : '',
            'CORRECTION_FLAG' => isset($arrDataDetail[0]['CORRECTION_FLAG'])
                                ? fncHtmlSpecialChars(trim($arrDataDetail[0]['CORRECTION_FLAG'])) : '',
            'BUSINESS_NAME' => isset($arrDataDetail[0]['BUSINESS_NAME'])
                                ? fncHtmlSpecialChars(trim($arrDataDetail[0]['BUSINESS_NAME'])) : '',
            'BUSINESS_NAME_ENG' => isset($arrDataDetail[0]['BUSINESS_NAME_ENG'])
                                ? fncHtmlSpecialChars(trim($arrDataDetail[0]['BUSINESS_NAME_ENG'])) : '',
            'INCIDENT_NAME_JPN' => isset($arrDataDetail[0]['INCIDENT_NAME_JPN'])
                                ? fncHtmlSpecialChars(trim($arrDataDetail[0]['INCIDENT_NAME_JPN'])) : '',
            'INCIDENT_NAME_ENG' => isset($arrDataDetail[0]['INCIDENT_NAME_ENG'])
                                ? fncHtmlSpecialChars(trim($arrDataDetail[0]['INCIDENT_NAME_ENG'])) : '',
            'PLACE_NAME' => isset($arrDataDetail[0]['PLACE_NAME'])
                                ? fncHtmlSpecialChars(trim($arrDataDetail[0]['PLACE_NAME'])) : '',
            'PLACE_NAME_ENG' => isset($arrDataDetail[0]['PLACE_NAME_ENG'])
                                ? fncHtmlSpecialChars(trim($arrDataDetail[0]['PLACE_NAME_ENG'])) : '',
        );
    }

    /**
     *	function: インシデント事案取得
     *
     *	@create	2020/03/24 Chien AKB
     *	@update
     *	@params	$intId      bulletin_no
     *	@return $arrResult  array data info of bulletin_no
     */
    function getInfoBullentin($intId) {
        $arrResult = array();
        if($intId == '') {
            return $arrResult;
        }
        $strSQL = ' SELECT '
                . '     tbb.BULLETIN_BOARD_NO '
                . '     , tbb.OCCURRENCE_DATE '
                . '     , tbb.CORRECTION_FLAG '
                . '     , tbb.BUSINESS_NAME '
                . '     , mbn.BUSINESS_NAME_ENG '
                . '     , tbb.INCIDENT_NAME_JPN '
                . '     , tbb.INCIDENT_NAME_ENG '
                . '     , tbb.PLACE_NAME '
                . '     , mpn.PLACE_NAME_ENG '
                . ' FROM '
                . '     t_bulletin_board AS tbb '
                . '     LEFT OUTER JOIN m_business_name AS mbn '
                . '         ON tbb.BUSINESS_NAME = mbn.BUSINESS_NAME_JPN '
                . '     LEFT OUTER JOIN m_place_name AS mpn '
                . '         ON tbb.PLACE_NAME = mpn.PLACE_NAME_JPN '
                . ' WHERE '
                . '     tbb.BULLETIN_BOARD_NO = ? ';
        try {
            $arrResult = fncSelectData($strSQL, array($intId),
                                        1, false, DISPLAY_TITLE);
            return $arrResult;
        } catch (\Exceoption $e) {
            fncWriteLog(LogLevel['Error'], LogPattern['Error'],
                DISPLAY_TITLE.' '.$e->getMessage());
            return 0;
        }
    }

    $strCSRF = isset($_POST['X-CSRF-TOKEN']) ? $_POST['X-CSRF-TOKEN'] : '';
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="csrf-token" content="<?php echo (isset($strCsrf) ? $strCsrf : ''); ?>">
    <meta charset="UTF-8">
    <title><?php echo $arrTxtTrans['BULLETIN_BOARD_VIEW_TEXT_001']; ?></title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>
    <div class="main-content">
        <div class="main-form">
            <div class="form-title"><?php echo $arrTxtTrans['BULLETIN_BOARD_VIEW_TEXT_001']; ?></div>
            <div class="form-body">
                <div class="error-messeage">
                    <?php if($arrResult['CORRECTION_FLAG'] == 0) { ?>
                    <div><?php echo PUBLIC_TEXT_001_JPN; ?></div>
                    <div><?php echo PUBLIC_TEXT_001_ENG; ?></div>
                    <?php } ?>
                    <?php
                        if($arrDataDetail == 0) {
                            echo '<div>'.$arrTxtTrans['PUBLIC_MSG_001'].'</div>';
                        } else {
                            if(count($arrDataDetail) == 0) {
                    ?>
                        <script>
                            alert('<?php echo $arrTxtTrans['BULLETIN_BOARD_VIEW_MSG_001']; ?>');
                            $('#myModal').modal('hide');
                        </script>
                    <?php
                            }
                        }
                    ?>
                </div>
                <div class="cont-title">
                    <div class="in-lineblock col-left">
                        <div class="title"><?php
                            echo BULLETIN_BOARD_VIEW_TEXT_002_JPN; ?>/<?php
                            echo BULLETIN_BOARD_VIEW_TEXT_002_ENG;
                        ?></div>
                        <div class="title"><?php echo date('Y/m/d H:i', strtotime($arrResult['OCCURRENCE_DATE'])); ?></div>
                    </div>
                    <div class="col-right in-lineblock right-20">
                        <?php
                            if(@$objLoginUserInfo->intBulletinBoardRegPerm
                                && $objLoginUserInfo->intBulletinBoardRegPerm == 1) {
                        ?>
                        <button type="button" class="tbtn tbtn-defaut load-modal" href="bulletin_board_edit.php"
                            data-id="<?php echo $arrResult['BULLETIN_BOARD_NO']; ?>"
                            id="btn-edit" onclick="loadModal('bulletin_board_edit.php')"><?php
                            echo $arrTxtTrans['PUBLIC_BUTTON_002']; ?></button>
                        <?php } ?>
                    </div>
                </div>

                <div>
                    <div class="title"><?php
                        echo BULLETIN_BOARD_VIEW_TEXT_003_JPN; ?>/<?php
                        echo BULLETIN_BOARD_VIEW_TEXT_003_ENG;
                    ?></div>
                    <div class="info-left">
                        <div class="line">
                            <div class="in-line tlabel">(<?php
                                echo PUBLIC_TEXT_002_JPN; ?>/<?php
                                echo PUBLIC_TEXT_002_ENG;
                            ?>)</div>
                            <div class="in-line text-input text-bold"><?php
                                echo $arrResult['BUSINESS_NAME']?></div>
                        </div>
                        <div class="line">
                            <div class="in-line tlabel">(<?php
                                echo PUBLIC_TEXT_003_JPN; ?>/<?php
                                echo PUBLIC_TEXT_003_ENG;
                            ?>)</div>
                            <div class="in-line text-input text-bold"><?php
                                echo $arrResult['BUSINESS_NAME_ENG']; ?></div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="title"><?php
                        echo BULLETIN_BOARD_VIEW_TEXT_004_JPN; ?>/<?php
                        echo BULLETIN_BOARD_VIEW_TEXT_004_ENG;
                    ?></div>
                    <div class="info-left">
                        <div class="line">
                            <div class="in-line tlabel">(<?php
                                echo PUBLIC_TEXT_002_JPN; ?>/<?php
                                echo PUBLIC_TEXT_002_ENG;
                            ?>)</div>
                            <div class="in-line text-input text-bold"><?php
                                echo $arrResult['INCIDENT_NAME_JPN']; ?></div>
                        </div>
                        <div class="line">
                            <div class="in-line tlabel">(<?php
                                echo PUBLIC_TEXT_003_JPN; ?>/<?php
                                echo PUBLIC_TEXT_003_ENG;
                            ?>)</div>
                            <div class="in-line text-input text-bold"><?php
                                echo $arrResult['INCIDENT_NAME_ENG']; ?></div>
                        </div>
                    </div>
                </div>
                <div class="col-left">
                    <div class="title"><?php
                        echo BULLETIN_BOARD_VIEW_TEXT_005_JPN; ?>/<?php
                        echo BULLETIN_BOARD_VIEW_TEXT_005_ENG;
                    ?></div>
                    <div class="info-left">
                        <div class="line">
                            <div class="in-line tlabel">(<?php
                                echo PUBLIC_TEXT_002_JPN; ?>/<?php
                                echo PUBLIC_TEXT_002_ENG;
                            ?>)</div>
                            <div class="in-line text-input text-bold"><?php
                                echo $arrResult['PLACE_NAME']; ?></div>
                        </div>
                        <div class="line">
                            <div class="in-line tlabel">(<?php
                                echo PUBLIC_TEXT_003_JPN; ?>/<?php
                                echo PUBLIC_TEXT_003_ENG;
                            ?>)</div>
                            <div class="in-line text-input text-bold"><?php
                                echo $arrResult['PLACE_NAME_ENG']; ?></div>
                        </div>
                    </div>
                </div>

                <div class="form-footer text-right right-20">
                    <button type="submit" class="tbtn-cancel tbtn-defaut closeModal"
                        id="close"
                        data-dismiss="modal"><?php
                        echo $arrTxtTrans['PUBLIC_BUTTON_003'];
                    ?></button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function() {
            $('.closeModal').on('click', function(e) {
                var nameScreen = '<?php echo (@$_POST['screen'])
                                    ? trim($_POST['screen']) : '' ?>';
                if(nameScreen == 'bulletin_mng' || nameScreen == 'bulletin_edit') {
                    setTimeout(function() {
                        window.location.reload();
                    }, 300);
                } else {
                    var data = [
                        {name: 'X-CSRF-TOKEN', value: '<?php echo $strCSRF; ?>' },
                        {name: 'action',value: 'load_bull' }
                    ];
                    $.ajax({
                        url : 'bull_form.php',
                        type : "POST",
                        dataType:"text",
                        data : data,
                        success : function (result){
                            if(result){
                                $('#bull_form').html(result);
                            }
                        }
                    });
                    $('#myModal').modal('hide');
                }
                return;
            });
        });
    </script>
</body>
</html>