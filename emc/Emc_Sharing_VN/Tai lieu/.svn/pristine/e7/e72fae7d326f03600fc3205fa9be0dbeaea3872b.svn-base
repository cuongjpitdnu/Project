<?php
/*
*	@login_otp_proc.php
*
*	@create	2020/04/14 KBS Tam
*	@update
*/

require_once('C:/information_sharing/common/common.php');
require_once('C:/information_sharing/common/Rakunin/cloudentifysdk.php');

header('Content-type: text/html; charset=utf-8');
header('X-FRAME-OPTIONS: DENY');

const DISPLAY_NAME = 'ログイン(OTP認証)画面';

$arrMSG = [
    'LOGIN_MSG_007',
    'LOGIN_MSG_008',
    'LOGIN_MSG_009',
    'LOGIN_MSG_010',
    'LOGIN_MSG_011',
    'LOGIN_MSG_012',
    'LOGIN_MSG_013',
    'LOGIN_MSG_014',

    'PUBLIC_MSG_049',
];

$strDisable = '';
//DB接続
if(fncConnectDB() == false){
	$_SESSION['LOGIN_OTP_ERROR'] = 'DB接続に失敗しました。';
	header('Location: login.php');
	exit;
}



/*if(empty($_POST)){
    if(isset($objLoginUserInfo->intLanguageType)){
        $strMes = $arrText['PUBLIC_MSG_049'];
    }else{
        $strMes = PUBLIC_MSG_049_JPN."/".PUBLIC_MSG_049_ENG;
    }
    echo "<script>alert('".$strMes."');
    history.back();</script>";
}

$strCsrf = @$_POST['X-CSRF-TOKEN'];*/

if(isset($_POST['txtUserId'])){
    if($_POST['mode'] == 1){
        $strViewLog = DISPLAY_NAME.' 表示 (ユーザID = '.$_POST['txtUserId'].') '.
            (isset($_SERVER['HTTP_REFERER']) ? $_SERVER['HTTP_REFERER'] : null);
        fncWriteLog(LogLevel['Info'] , LogPattern['View'], $strViewLog);
    }
    //入力ユーザID
    $strUserID = $_POST['txtUserId'];
    //入力パスワード
    $strPassword = $_POST['txtPassword'];
    $strMode = $_POST['mode'];

    //ユーザID未入力
    if(mb_strlen($strUserID) == 0){
        $_SESSION['LOGIN_OTP_ERROR'] = LOGIN_MSG_001_JPN .'/'.LOGIN_MSG_001_ENG.'<br>';
    }

    //パスワード未入力
    if(mb_strlen($strPassword) == 0){
        if(isset($_SESSION['LOGIN_OTP_ERROR'])){
            $_SESSION['LOGIN_OTP_ERROR'] .= LOGIN_MSG_002_JPN .'/'.LOGIN_MSG_002_ENG.'<br>';
        }else{
            $_SESSION['LOGIN_OTP_ERROR'] = LOGIN_MSG_002_JPN .'/'.LOGIN_MSG_002_ENG.'<br>';
        }
    }

    if(isset($_SESSION['LOGIN_OTP_ERROR'])){
        header('Location: login.php');
        exit;
    }
//ユーザデータ取得
    $arrUserData = fncLogin($strUserID, $strPassword);

    if($arrUserData){
        $arrText = getListTextTranslate($arrMSG,$arrUserData[0]['language_type']);
        fncValideUser($arrUserData);
        $intMode = $_POST['mode'];
        $_SESSION['language_type'] = $arrUserData[0]['language_type'];
        if($intMode == 1){
            $intType = 1;
            $intResult = fncRakuService($arrUserData[0]['user_id'],1);
            if($intResult == OTP_OK){
                $intType = 4;
                $intResult = fncRakuService($arrUserData[0]['user_id'],4);
            }
            if($intResult){
                $strError = fncErrorSendSMS($intResult,$intType,$arrText);
            }else{
                $intMode = 2;
                $strDisable = 'disabled';
            }
        }else{
            $strDisable = 'disabled';
            $strCode = $_POST['txtOTP'];
            $intResult = fncRakuService($arrUserData[0]['user_id'],6,$strCode);
            if($intResult){
                $strError = fncErrorSendSMS($intResult,6,$arrText);
                $_SESSION['LOGIN_OTP_ERROR'] .= $strError;
            }else{
                fncProcessLogin($arrUserData);
            }
        }
    }else{
        //ユーザID、パスワードに一致したユーザがいない
        $_SESSION['LOGIN_OTP_ERROR'] = LOGIN_MSG_003_JPN. ' / ' .LOGIN_MSG_003_ENG;
        header('Location: login.php');
        exit;
    }

    //権限設定の有無
    if($arrUserData[0]['perm_flag'] == 0){
        $_SESSION['LOGIN_OTP_ERROR'] = LOGIN_MSG_004_JPN. ' / ' .LOGIN_MSG_004_ENG;
        header('Location: login.php');
        exit;
    }

    $strCsrf = $_SESSION['csrf'];
}

function fncValideUser($arrUserData){
    //有効期限開始
        $dtmExpirationDateStart = new DateTime($arrUserData[0]['expiration_date_s']);
    //有効期限終了
        $dtmExpirationDateEnd = new DateTime($arrUserData[0]['expiration_date_e']);
    //パスワード更新日
        $dtmPassUpDate = new DateTime($arrUserData[0]['password_up_date']);

    //ユーザの有効期限が切れているか
        if($dtmExpirationDateStart->format('Y/m/d') > date("Y/m/d")
            || $dtmExpirationDateEnd->format('Y/m/d') < date("Y/m/d")){
            $_SESSION['LOGIN_OTP_ERROR'] = LOGIN_MSG_005_JPN. ' / ' .LOGIN_MSG_005_ENG;
            header('Location: login.php');
            exit;
        }

    //パスワード有効期限
    $dtmPassUpDate = $dtmPassUpDate->modify('+'.PASSWORD_PERIOD_DAY.' days');

    //パスワードの有効期限が切れている場合、パスワード変更画面に遷移
    if($dtmPassUpDate->format('Y/m/d') < date("Y/m/d")){
        $_SESSION['csrf'] =fncGetCsrfToken();
        $strCsrf = $_SESSION['csrf'];
        ?>
        <form action="password_chg.php" method="post" name="passchange">
            <input type="hidden" name="user_no" value="<?php echo $arrUserData[0]['user_no']?>">
            <input type="hidden" name="X-CSRF-TOKEN" value="<?php echo $strCsrf;?>">
        </form>
        <script>document.passchange.submit();</script>
        <?php
        exit;
    }

}

function fncProcessLogin($arrUserData){
    //有効期限開始
        $dtmExpirationDateStart = new DateTime($arrUserData[0]['expiration_date_s']);
    //有効期限終了
        $dtmExpirationDateEnd = new DateTime($arrUserData[0]['expiration_date_e']);
    //パスワード更新日
        $dtmPassUpDate = new DateTime($arrUserData[0]['password_up_date']);

    //ユーザの有効期限が切れているか
        if($dtmExpirationDateStart->format('Y/m/d') > date("Y/m/d")
            || $dtmExpirationDateEnd->format('Y/m/d') < date("Y/m/d")){
            $_SESSION['LOGIN_OTP_ERROR'] = LOGIN_MSG_005_JPN. ' / ' .LOGIN_MSG_005_ENG;
            header('Location: login.php');
            exit;
        }

    //パスワード有効期限
    $dtmPassUpDate = $dtmPassUpDate->modify('+'.PASSWORD_PERIOD_DAY.' days');

    //パスワードの有効期限が切れている場合、パスワード変更画面に遷移
    if($dtmPassUpDate->format('Y/m/d') < date("Y/m/d")){
        $_SESSION['csrf'] =fncGetCsrfToken();
        $strCsrf = $_SESSION['csrf'];
        ?>
        <form action="password_chg.php" method="post" name="passchange">
            <input type="hidden" name="user_no" value="<?php echo $arrUserData[0]['user_no']?>">
            <input type="hidden" name="X-CSRF-TOKEN" value="<?php echo $strCsrf;?>">
        </form>
        <script>document.passchange.submit();</script>
        <?php
        exit;
    }

    //新たなセッション情報を生成
    session_regenerate_id(true);

    //セッションにログインユーザ情報を格納
    $objLoginUserInfo = new clsLoginUserInfo();
    $objLoginUserInfo->intUserNo = $arrUserData[0]['user_no'];
    $objLoginUserInfo->strUserID = $arrUserData[0]['user_id'];
    $objLoginUserInfo->intLanguageType = $arrUserData[0]['language_type'];
    $objLoginUserInfo->intCompanyNo = $arrUserData[0]['company_no'];

    if($objLoginUserInfo->intLanguageType == 0){
        $objLoginUserInfo->strCompanyName = $arrUserData[0]['company_name_jpn'];
    }else{
        $objLoginUserInfo->strCompanyName = $arrUserData[0]['company_name_eng'];
    }

    $objLoginUserInfo->intGroupNo = $arrUserData[0]['group_no'];
    $objLoginUserInfo->strUserName = $arrUserData[0]['user_name'];
    $objLoginUserInfo->intJcmgTabPerm = $arrUserData[0]['jcmg_tab_perm'];
    $objLoginUserInfo->intAnnounceRegPerm = $arrUserData[0]['announce_reg_perm'];
//$objLoginUserInfo->intBulletinBoardRegPerm = $arrUserData[0]['bulletin_board_reg_perm'];
    $objLoginUserInfo->intBulletinBoardRegPerm = 1;
    $objLoginUserInfo->intQueryRegPerm = $arrUserData[0]['query_reg_perm'];
    $objLoginUserInfo->intIncidentCaseRegPerm = $arrUserData[0]['incident_case_reg_perm'];
    $objLoginUserInfo->intRequestRegPerm = $arrUserData[0]['request_reg_perm'];
    $objLoginUserInfo->intInformationRegPerm = $arrUserData[0]['information_reg_perm'];
    $objLoginUserInfo->intMenuPerm = $arrUserData[0]['menu_perm'];


    $objLoginUserInfo->strMailAddress = $arrUserData[0]['mail_address'];
    $objLoginUserInfo->intAnnounceMail = $arrUserData[0]['announce_mail'];
    $objLoginUserInfo->intBulletinBoardMail = $arrUserData[0]['bulletin_board_mail'];
    $objLoginUserInfo->intIncidentCaseMail = $arrUserData[0]['incident_case_mail'];
    $objLoginUserInfo->intRequestContentsMail = $arrUserData[0]['request_contents_mail'];

    $_SESSION['LOGINUSER_INFO'] = serialize($objLoginUserInfo);

    $_SESSION["SES_TIME"] = date( "Y/m/d H:i:s", time() );


//ログ内容
    $strLog  = 'ログイン ';
    $strLog .= '（ユーザID = '.$objLoginUserInfo->strUserID;
    $strLog .= ', IPアドレス =' .$_SERVER["REMOTE_ADDR"] .' ） ';
    $strLog .= $_SERVER["HTTP_USER_AGENT"];
//ログ書き込み
    fncWriteLog(LogLevel['Info'] , LogPattern['Login'], $strLog);
//ポータル画面へ遷移
    header('Location: info_src/portal.php');
    exit();
}

function fncErrorSendSMS($intCodeError,$intType,$arrText){
    switch ($intCodeError)
    {
        case 203:
            $strError = $arrText['LOGIN_MSG_008'];
            break;
        case 506:
            $strError = $arrText['LOGIN_MSG_009'];
            break;

        case 206:
            $strError = $arrText['LOGIN_MSG_010'];
            break;

        case 7:
            $strError = $arrText['LOGIN_MSG_011'];
            break;


        default:
            if($intType == 1){
                $strError = $arrText['LOGIN_MSG_007'] ;
            }else if($intType == 4){
                $strError = $arrText['LOGIN_MSG_012'];
            }else{
                $strError = $arrText['LOGIN_MSG_013'];
            }
            break;
    }
    $strError .= $arrText['LOGIN_MSG_014'].' '.OTP_ERROR_MAILADDRESS;
    fncWriteLog(LogLevel['Error'], LogPattern['Error'], DISPLAY_NAME.' '.$strError);

    if($intType != 6){
        $_SESSION['LOGIN_OTP_ERROR'] = $strError;
        header('Location: login.php');
        exit;
    }else{
        return $strError;
    }
}

function fncRakuService($user_name,$test_type,$otp = NULL,$phone_sn = ''){
    $server_url = "https://auth.rakunin.co.jp";
    $app_id = RAKUNIN_APP_ID;
    $app_secret = RAKUNIN_APP_SECRET;
    $retry = 0;

    $cloudentifysdk = new cloudentifysdk();
    $ret = $cloudentifysdk->init($server_url, $app_id, $app_secret);
    switch ($test_type)
    {
        case 1:
            //is_user_exist
            $ret = $cloudentifysdk->is_user_exist($user_name);
            break;
        case 2:
            //add_user
            $ret = $cloudentifysdk->add_user($user_name);
            break;

        case 3:
            //add_user_phone
            $ret = $cloudentifysdk->add_user_phone($user_name, $phone_sn);
            break;

        case 4:
            //send_smsotp
            $ret = $cloudentifysdk->send_smsotp($user_name, $phone_sn);
            break;
        case 5:
            //get_smsotp
            $ret = $cloudentifysdk->get_smsotp($user_name, $smsotp);
            break;

        case 6:
            //user_otp_auth
            $ret = $cloudentifysdk->user_otp_auth($user_name, $otp, $retry);
            break;

        case 7:
            //sms_push_auth
            $ret = $cloudentifysdk->sms_push_auth($user_name, $phone_sn);
            break;
        default:
            echo "<br>Error test type!<br>";
            break;
    }

    $cloudentifysdk->uninit();
    return $ret;
}

?>
